# Отчёт о выполнении задачи "Sprayer"

- [Отчёт о выполнении задачи "Sprayer"](#отчёт-о-выполнении-задачи-sprayer)
  - [Постановка задачи](#постановка-задачи)
  - [Известные ограничения, примечания и вводные данные](#известные-ограничения-примечания-и-вводные-данные)
    - [Цели и Предположения Безопасности (ЦПБ)](#цели-и-предположения-безопасности-цпб)
  - [Архитектура работы системы](#архитектура-работы-системы)
    - [Компоненты](#компоненты)
    - [Алгоритм работы решения](#алгоритм-работы-решения)
    - [Описание Сценариев (последовательности выполнения операций), при которых ЦБ нарушаются](#описание-сценариев-последовательности-выполнения-операций-при-которых-цб-нарушаются)
    - [Указание "доверенных компонент" на архитектурной диаграмме с обоснованием выбора.](#указание-доверенных-компонент-на-архитектурной-диаграмме-с-обоснованием-выбора)
    - [Известные проблемы реализации](#известные-проблемы-реализации)
    - [Политики безопасности](#политики-безопасности)
  - [Запуск приложения и тестов](#запуск-приложения-и-тестов)
    - [Запуск приложения](#запуск-приложения)
    - [Запуск тестов](#запуск-тестов)

## Постановка задачи
Необходимо создать программное обеспечение (далее – ПО) для беспилотного летательного аппарата (далее – дрон), с помощью которого можно обеспечить безопасное управление через мобильное приложение (далее - МП)
или управляющий центр (далее – УЦ) и выполнение задач дроном. К задачам дрона относим: распыление пестицидов или удобрений (далее – смесь) по заданному участку или сброс нужного количества смеси в конкретных координатах.

## Известные ограничения, примечания и вводные данные:
1. По условиям организаторов должна использоваться микросервисная архитектура и шина обмена сообщениями для реализации асинхронной работы сервисов.
2. Обмен данными с УЦ: прием и отправка сообщений.
3. Между собой сервисы общаются через шину сообщений (message bus), а всё снаружи принимают в виде REST запросов.
4. Выполнение команд, принятых от мобильного приложения и УЦ.
5. Геолокация: позиционирование на местности по двум системам - GPS (спутниковая навигационная система) и ИНС (инерциальная навигационная система).
6. Автономность: выполнение программы распыления смеси, защита в случае попытки перехвата управления или многократных попыток передачи некорректных сообщений, действия в случае потери связи. Дрон должен выполнять полётное задание в случае утраты связи с УЦ и МП в условиях отсутствия аварий.
7. Контроль: уровень заряда, количество смеси, обработка территории, распознавание живых объектов (животных и людей), поломка. В случае критических проблем дрон должен вернуться на базу.
8. Мониторинг происходящего на земле: распыление смеси только на землю или растения.
9. Возврат на базу в случае нештатных ситуаций (в т.ч. в случае сбоя GPS). База имеет фиксированные координаты (x1,y1,z1),
возврат происходит с использованием ИНС (инерциальной навигационной системы). В отсутствие GPS возврат на базу без распыления.
10. ИНС является автономной навигационной системой, но накапливает ошибку, поэтому должна использоваться только в случае сбоя GPS.
11. Из-за внешних обстоятельств GPS навигация может быть невозможной, это необходимо учитывать в решении.
12. Мониторинг происходящего может быть реализован как простой сервис, выдающий состояние "можно распылять" или "нельзя распылять"
13. Надёжность аппаратуры не учитывается
14. Смесь не имеет массы и объёма.
15. Графический интерфейс для взаимодействия с пользователем не требуется, достаточно примеров REST запросов.
16. Приборная точность позиционирования достаточна для выполнения полётного задания.


### Цели и Предположения Безопасности (ЦПБ)
**Бизнес-цель:**
  - Выполнение задачи по опылению и/или безопасное возвращение на базу.

**Цели безопасности:**
1. Обеспечение безопасности дрона от перехвата управления.
2. Получение задания только от корпоративного сервера.
3. В случае многократных попыток неавторизованного доступа вернуться на базу.

**Предположения безопасности:**
Целями безопасности дрона не являются:
1. Защита от атак с использованием физического доступа (к чему угодно - дрону, МП, УЦ)
2. Защита от намеренного искажения GPS координат

## Архитектура работы системы
![DFD](./pics/dataflow_task.png?raw=true "Потоки данных")
![DFD_2](./pics/dfd.png?raw=true "Архитектура")

### Компоненты

Изначально заказчик предусматривал следующую структуру:

| Название | Назначение | Комментарий |
|----|----|----|
|*Управляющий центр / Control Center (control)* | Создает полетные задания для дронов. Распределяет полетные маршруты и проверяет их на безопасность с точки зрения пересечения. Ведет реестр ошибок и аварийных ситуаций.
Регистрирует результаты выполнения полетных заданий. Взаимодействует с дроном через API. |  |
|*Мобильное приложение / Mobile Application (mobile)* | Получает информацию о состоянии дрона в течении всего периода взаимодействия/ управления полетом. Передает дрону различные команды (запуск, возвращение на базу). Взаимодействует с дроном через API. | |
|*Оператор / Operator (operator)* | Взаимодействует с дроном через API. Использует для авторизации уже известный ему уникальный PIN код (программная реализация механизма передачи PIN кода клиенту не требуется), но этот же PIN код использует и control при отправке задания. | |
|*Управление полетом / Dispatcher (dispatcher)*  | Контролирует состояние дрона. Контролирует исполнение полетного задания. Отслеживает позиционирование дрона в 3D. Поддерживает связь с УЦ и мобильным приложением. В задаче использует только API. | |
|*Инерциальная навигационная система / Inertial Navigation System (ins)* | Ведет GPS-независимую карту полета. Строит аварийный маршрут возвращения на базу. | опционально |
|*GPS (gps)* | Выдаёт текущие координаты (x, y, z). Отслеживает прерывание сигнала. Отслеживает ошибки позиционирования. | |
|*Конроль обстановки / Situation control (situation)* | Контролирует высоту полета. Контролирует появление наземных объектов (люди, животные) в месте распрыскивания смеси. Контролирует состояние датчиков столкновения. | |
|*Опылитель / Sprayer* | Контролирует расход смеси. Отключает и включает распрыскиватель в заданных точках маршрута. Управляет аварийным выключением распрыскивателя. | |
|*Контроль состояния / State control (state)*<br>(монитор безопасности) | Контролирует уровень заряда батареи. Контролирует состояние распрыскивателя. Контролирует уровень смеси (сколько осталось). Контролирует состояние прочих модулей дрона. | |
|*Security monitor*<br>(монитор безопасности) | авторизует операцию, если она удовлетворяет заданным правилам или блокирует её в противном случае | |
|*Message bus* | шина сообщений и брокер - сервис передачи сообщений от источника получателям | kafka+zookeeper | |

Она представляется несколько избыточной, поэтому объединим ins и pgs в блок position. Аналогично поступим с state, перенеся его в dispatcher -> это возможно сделать, поскольку смысл компонента в (фактически) мониторинге и
сохранении параметров работы дрона, а управляет этим и обрабатывает ошибки все равно dispatcher.
Кроме того, традиционно вынесем в отдельный модель блок связи с "внешним миром", т.е. с УЦ и МП, назовем его connector.
Пересмотрим функционал "Контроля обстановки" - лишим его контроля высоты и столкновения в пользу более "тематических" модулей, переименуем в recognize - теперь он отвечает за распознавание препятский и пр. объектов в ходе работы.

Получим следующий набор компонентов:

| Название | Назначение | Комментарий |
|----|----|----|
|*Управляющий центр (control)* | Создает полетные задания для дронов. Распределяет полетные маршруты и проверяет их на безопасность с точки зрения пересечения. Ведет реестр ошибок и аварийных ситуаций. Регистрирует результаты выполнения полетных заданий. Взаимодействует с дроном через API. |  |
|*Мобильное приложение (mobile)* | Получает информацию о состоянии дрона в течении всего периода взаимодействия/ управления полетом. Передает дрону различные команды (запуск, возвращение на базу). Взаимодействует с дроном через API. | |
|*Оператор (operator)* | Взаимодействует с дроном через API. Использует для авторизации уже известный ему уникальный PIN код (программная реализация механизма передачи PIN кода клиенту не требуется), но этот же PIN код использует и control при отправке задания. | |
|*Управление полетом (dispatcher)*  | Контролирует состояние дрона (заряд батареи, состояние распылителя, уровень смеси, датчиков столкновения, иные модули). Контролирует исполнение полетного задания. Отслеживает позиционирование дрона в 3D. | |
|*Позиционирование (position)* | Ведет GPS-независимую карту полета. Строит аварийный маршрут возвращения на базу. Выдаёт текущие координаты (x, y, z). Отслеживает прерывание сигнала. Отслеживает ошибки позиционирования. Контролирует высоту полета. | опционально |
|*Распознавание (recognizing)* | Контролирует появление наземных объектов (люди, животные) в месте распрыскивания смеси. | |
|*Опылитель (sprayer)* | Контролирует расход смеси. Отключает и включает распрыскиватель в заданных точках маршрута. Управляет аварийным выключением распрыскивателя. | |
|*Передатчик (connector)* | Поддерживает связь с УЦ и мобильным приложением через HTTP протокол. В задаче использует только API. Передает сообщения дальше в message bus. | |
|*Security monitor*<br>(монитор безопасности) | Авторизует операцию, если она удовлетворяет заданным правилам или блокирует её в противном случае | |
|*Message bus* | Шина сообщений и брокер - сервис передачи сообщений от источника получателям | kafka+zookeeper | |


### Алгоритм работы решения

**Как было изначально:**
![Sequence diagram](./pics/sd.png?raw=true "Диаграмма вызовов")

---
**Важно!**
Message bus и Security Monitor на диаграммах опущены для лучшей читаемости и уменьшения размера картинки. КАЖДОЕ сообщение внутри системы проходит через monitor, который исходя из политик принимает решение пропустить его или нет.
---

**Как стало после осмысления:**

![Sequence diagram_2](./pics/sd_v2.png?raw=true "Диаграмма вызовов")

### Описание Сценариев (последовательности выполнения операций), при которых ЦБ нарушаются

Обратим внимание на определенные по заданию доверенные и надежные компоненты - **message bus** и **monitor**.
При этом считается, что все сообщения безальтернативно идут через **monitor**, который применяет политики безопасности.

Резюмируя:


Заказчиком были представлены наиболее волнующие его негативные сценарии атаки, разберем их:
 - Физический доступ к смартфону с мобильным приложением. Получен доступ к файловому хранилищу телефона и временным файлам приложения. Таким образом, для стороннего использования доступны разнообразные данные, например данные геолокации, персональные данные, учетные записи, финансовая информация и т.д.
 - Подключение к недоверенному Wi-Fi-роутеру. Атака через канал связи. Перехват всех передаваемых данных, как от смартфона, так и от сервера и дрона, к которому в данный момент обращается. Это открывает возможность для фишинга .
 - Недостаточная защита от подбора учетных данных (подбор PIN-кода), которая может привести к компрометации данных и финансовым потерям. Например, можно дать команду дрону выпустить все пестициды над водной поверхностью: река, озеро. И пестициды попадут в водозабор, потравят рыбу и распространятся дальше по руслу реки.
 - Глушение канала передачи информации мобильное приложение <-> дрон (gsm, wifi, ic и т.п.). При отсутствии реализованного аварийного сценария поведения дрона может быть сорвана обработка поля. Например, если поднять дрон высоко, то пестициды ветром разнесет далеко за границы опрыскиваемого участка. Также возможна физическая потеря дрона от столкновения, если его направить на какой-либо объект инфраструктуры.
 - Перехват команды/полетного задания и внедрение в него недостоверной информации. Таким образом, доступна подмена пакета при передаче через промежуточные звенья и возможен перехват управления дроном. В том числе, через дрон возможно взломать центр управления и сфальсифицировать все полетные задания. Одна емкость с химикатами особо может ни на что не повлияет, а если скрытно почти незаметно вмешиваться в работу, так чтобы это не сразу отследили, то можно за десятки и сотни вылетов диверсию осуществлять.
 - DDOS атака на сервера УЦ несет за собой финансовые потери.

В результате произведенных над ней размышлений, наиболее вероятные сценарии нарушения ЦБ практически не изменились:
1. Заказ прислан злоумышленником + взлом connector; **авторизация + меры безопасности**
2. Прислан новый заказ; **блокировка**
3. Компонент взломан и меняет параметры запроса; **только в storage могут быть вопросы**
4. Какой-то компонент взломан и саботирует работу - простаивает; **тут все еще надо плакать**
5. Скрытые поля и их использование для code/sql injections; **валидация, экранирование**
6. Атака на "зависимости" - закладки в стороннем ПО, библиотеках; **локальные копии + проверка обновлений**
7. Неограниченное количество попыток на бронь оборудования/производных реагентов **в текущей реализации эта проблема минимальна**

![Негативные сценарии](./pics/sd_v2_risks.png?raw=true "Негативные сценарии")

**Отдельная диаграмма для первого негативного сценария - "чужого"" заказа:**
![Негативные сценарии](./pics/sd_rev2_1.png?raw=true "")

Нарушается цель безопасности №1.
Компенсируется использованием авторизации (реализовано "для вида") и криптографии + меры защиты на уровне сети и системы (out of scope).



### Указание "доверенных компонент" на архитектурной диаграмме.

В предыдущем параграфе были рассмотрены возможные сценарии нарушения ЦБ, по результатам чего были определены доверенные компоненты - **monitor**, **message bus**, **bre** и **equipment**, по причине того, что шина обмена сообщений и монитор безопасности являются общесистемными, а также мы хотим доверять результатам работы вычислителя вердиктов возможности выполнения опреции и самому исполнителю.

![DFD-TCB](./pics/dfd_dron.png?raw=true "Доверенные компоненты")

Теоретически, шину обмена сообщениями можно сделать недоверенным компонентом, но тогда необходимо будет реализовать механим верификации сообщений. Например, можно использовать технологию типа blockchain.
Цена этого изменения - усложнение обмена сообщениями, дополнительные накладные расходы на верификацию, снижение производительности системы, возможно также возникновение нестабильности и различные ситуации гонок.

### Известные проблемы реализации


### Политики безопасности


```python {lineNo:true}
import time
from producer import proceed_to_deliver


ordering = False
activated = False

def check_operation(id, details):
    global ordering
    global activated
    authorized = False

   # print(f"[info] checking policies for event {id},"\
   #       f" {details['source']}->{details['deliver_to']}: {details['operation']}")
    src = details['source']
    dst = details['deliver_to']
    operation = details['operation']
   
    if not activated:
      if src == 'connector' and dst == 'dispatcher' \
         and operation == 'activate':
            activated = True
            authorized = True    
    else:
        if src == 'connector' and dst == 'monitor' \
            and operation == 'deactivate':
            activated = False
            authorized = True  

    if activated:
        if not ordering:
            if  src == 'connector' and dst == 'dispatcher' \
                and operation == 'task' and len(details) == 12 :
                authorized = True 
        else:
            det = details.copy()
            det['operation'] = 'reject'
            det['deliver_to'] = 'monitor'
            print('rejected')
            proceed_to_deliver(det['id'], det)
            time.sleep(1)
                #todo check content of another fields
        if src == 'dispatcher' and dst == 'position' \
            and operation == 'move_to':
            authorized = True  
        if src == 'dispatcher' and dst == 'position' \
            and operation == 'where_am_i':
            authorized = True    
        if src == 'dispatcher' and dst == 'sprayer' \
            and operation == 'stop':
            authorized = True  
        if src == 'dispatcher' and dst == 'sprayer' \
            and operation == 'start':
            authorized = True    
        if src == 'dispatcher' and dst == 'connector' \
            and operation == 'ask_task':
            authorized = True
        if  src == 'dispatcher' and dst == 'connector'\
            and operation == 'error':
            authorized = True
        if  src == 'dispatcher' and dst == 'position'\
            and operation == 'nonexistent':
            authorized = True
        if  src == 'dispatcher' and dst == 'position'\
            and operation == 'nonexistent2':
            authorized = True
        if  src == 'dispatcher' and dst == 'connector'\
            and operation == 'operation_status':
            authorized = True
            ordering = False

        if  src == 'position' and dst == 'dispatcher'\
            and operation == 'parameters':
            authorized = True
        if  src == 'position' and dst == 'dispatcher'\
            and operation == 'spraying':
            authorized = True
        if  src == 'position' and dst == 'dispatcher'\
            and operation == 'operation_status':
            authorized = True
        if  src == 'position' and dst == 'dispatcher'\
            and operation == 'coordinates':
            authorized = True
            
        if  src == 'recognizer' and dst == 'dispatcher'\
            and operation == 'obstruction':
            authorized = True

    return authorized


```

## Запуск приложения и тестов

### Запуск приложения

см. [инструкцию по запуску](../../README.md)

### Запуск тестов

_Предполагается, что в ходе подготовки рабочего места все системные пакеты были установлены._

Запуск примера: открыть окно терминала в Visual Studio code, в папке drone с исходным кодом выполнить

**make run**
или **docker-compose up -d**

Примечание: сервисам требуется некоторое время для начала обработки входящих сообщений от kafka, поэтому перед переходом к тестам следует сделать паузу 1-2 минуты


запуск тестов (на данный момент отсутсвуют):
**make test**
или **pytest**

```python {lineNo:true}
tests/e2e/test_update.py::test_activate PASSED
tests/e2e/test_update.py::test_asking_task PASSED
tests/e2e/test_update.py::test_write_order PASSED
tests/e2e/test_update.py::test_success_result PASSED
tests/e2e/test_update.py::test_surface_result PASSED
tests/e2e/test_update.py::test_activate_without_token PASSED
tests/e2e/test_update.py::test_repeated_task PASSED
```
